<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Rifas Solidarias</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .navbar-brand {
            font-size: 1.5rem;
            font-weight: bold;
        }

        .navbar-user {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 500;
        }

        .user-role {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .welcome-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .welcome-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .welcome-subtitle {
            color: #666;
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
        }

        .stat-icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .quick-actions {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .section-title {
            font-size: 1.5rem;
            color: #333;
            margin-bottom: 1.5rem;
        }

        .actions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .action-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            text-decoration: none;
            display: block;
            text-align: center;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            text-decoration: none;
            color: white;
        }

        .action-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            display: block;
        }

        .recent-activity {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .activity-item {
            padding: 1rem 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 500;
            color: #333;
            margin-bottom: 0.25rem;
        }

        .activity-time {
            color: #666;
            font-size: 0.8rem;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .role-badge {
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            text-transform: uppercase;
            font-weight: 500;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background: #fee;
            color: #c53030;
            border: 1px solid #fed7d7;
        }

        @media (max-width: 768px) {
            .navbar {
                padding: 1rem;
            }
            
            .container {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .actions-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="navbar-brand">
            üéØ Rifas Solidarias
        </div>
        <div class="navbar-user">
            <div class="user-info">
                <div class="user-name" id="userName">Cargando...</div>
                <div class="user-role" id="userRole">
                    <span class="role-badge" id="roleBadge">-</span>
                </div>
            </div>
            <button class="btn-logout" onclick="refreshDashboard()" style="margin-right: 10px; background: rgba(255,255,255,0.1);">
                üîÑ Actualizar
            </button>
            <button class="btn-logout" onclick="handleLogout()">
                Cerrar Sesi√≥n
            </button>
        </div>
    </nav>

    <div class="container">
        <!-- Secci√≥n de Bienvenida -->
        <div class="welcome-section">
            <h1 class="welcome-title" id="welcomeTitle">¬°Bienvenido!</h1>
            <p class="welcome-subtitle" id="welcomeSubtitle">Cargando informaci√≥n...</p>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üé´</div>
                <div class="stat-number" id="totalRifas">-</div>
                <div class="stat-label">Rifas Activas</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üë•</div>
                <div class="stat-number" id="totalUsuarios">-</div>
                <div class="stat-label">Usuarios</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üè¢</div>
                <div class="stat-number" id="totalInstituciones">-</div>
                <div class="stat-label">Instituciones</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-number" id="totalVentas">-</div>
                <div class="stat-label">Ventas del Mes</div>
            </div>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="quick-actions">
            <h2 class="section-title">Acciones R√°pidas</h2>
            <div class="actions-grid" id="actionsGrid">
                <!-- Las acciones se cargar√°n din√°micamente seg√∫n el rol -->
            </div>
        </div>

        <!-- Actividad Reciente -->
        <div class="recent-activity">
            <h2 class="section-title">Actividad Reciente</h2>
            <div id="activityContainer">
                <div class="loading">
                    <div class="spinner"></div>
                    Cargando actividad reciente...
                </div>
            </div>
        </div>
    </div>

    <script src="js/authService.js"></script>
    <script>
        let currentUser = null;

        // Verificar autenticaci√≥n al cargar
        document.addEventListener('DOMContentLoaded', async function() {
            // Verificar que est√© autenticado
            if (!authService.isAuthenticated()) {
                authService.redirectToLogin();
                return;
            }

            try {
                // Obtener datos del usuario
                currentUser = authService.getCurrentUser();
                if (currentUser) {
                    displayUserInfo(currentUser);
                    loadQuickActions(currentUser.rol);
                }

                // Cargar datos del dashboard
                await loadDashboardData();
                await loadRecentActivity();

            } catch (error) {
                console.error('Error cargando dashboard:', error);
                showAlert('Error cargando el dashboard', 'error');
            }
        });

        // Mostrar informaci√≥n del usuario
        function displayUserInfo(user) {
            document.getElementById('userName').textContent = `${user.nombre} ${user.apellido}`;
            document.getElementById('userRole').innerHTML = `
                <span class="role-badge">${getRoleDisplayName(user.rol)}</span>
                ${user.institucion_nombre ? ` - ${user.institucion_nombre}` : ''}
            `;

            const now = new Date();
            const hour = now.getHours();
            let greeting = 'Buen d√≠a';
            if (hour >= 12 && hour < 18) greeting = 'Buenas tardes';
            if (hour >= 18) greeting = 'Buenas noches';

            document.getElementById('welcomeTitle').textContent = `${greeting}, ${user.nombre}!`;
            document.getElementById('welcomeSubtitle').textContent = 
                `Desde aqu√≠ puedes gestionar todas las actividades de rifas solidarias.`;
        }

        // Obtener nombre de rol para mostrar
        function getRoleDisplayName(rol) {
            const roles = {
                'admin_global': 'Admin Global',
                'admin_institucion': 'Admin Instituci√≥n',
                'vendedor': 'Vendedor',
                'comprador': 'Comprador'
            };
            return roles[rol] || rol;
        }

        // Cargar acciones r√°pidas seg√∫n el rol
        function loadQuickActions(userRole) {
            const actionsGrid = document.getElementById('actionsGrid');
            let actions = [];

            // Acciones comunes
            const commonActions = [
                { icon: 'üë§', text: 'Mi Perfil', url: '/perfil.html' },
            ];

            // Acciones seg√∫n rol
            switch (userRole) {
                case 'admin_global':
                    actions = [
                        { icon: 'üè¢', text: 'Gestionar Instituciones', url: '/admin/instituciones.html' },
                        { icon: 'üë•', text: 'Gestionar Usuarios', url: '/admin/usuarios.html' },
                        { icon: 'üé´', text: 'Ver Todas las Rifas', url: '/admin/rifas.html' },
                        { icon: 'üìä', text: 'Reportes Globales', url: '/admin/reportes.html' },
                        ...commonActions
                    ];
                    break;

                case 'admin_institucion':
                    actions = [
                        { icon: 'üé´', text: 'Crear Nueva Rifa', url: '/rifas/crear.html' },
                        { icon: 'üìã', text: 'Mis Rifas', url: '/rifas/lista.html' },
                        { icon: 'üë•', text: 'Gestionar Vendedores', url: '/usuarios/vendedores.html' },
                        { icon: 'üìà', text: 'Reportes', url: '/reportes.html' },
                        ...commonActions
                    ];
                    break;

                case 'vendedor':
                    actions = [
                        { icon: 'üé´', text: 'Vender N√∫meros', url: '/ventas/vender.html' },
                        { icon: 'üìã', text: 'Mis Ventas', url: '/ventas/lista.html' },
                        { icon: 'üéØ', text: 'Rifas Disponibles', url: '/rifas/disponibles.html' },
                        ...commonActions
                    ];
                    break;

                case 'comprador':
                default:
                    actions = [
                        { icon: 'üé´', text: 'Comprar N√∫meros', url: '/compras/rifas.html' },
                        { icon: 'üéüÔ∏è', text: 'Mis N√∫meros', url: '/compras/mis-numeros.html' },
                        { icon: 'üèÜ', text: 'Resultados', url: '/resultados.html' },
                        ...commonActions
                    ];
                    break;
            }

            // Renderizar acciones
            actionsGrid.innerHTML = actions.map(action => `
                <a href="${action.url}" class="action-btn">
                    <span class="action-icon">${action.icon}</span>
                    ${action.text}
                </a>
            `).join('');
        }

        // Cargar datos del dashboard
        async function loadDashboardData() {
            try {
                // Por ahora usamos datos mock, despu√©s conectaremos con las APIs reales
                document.getElementById('totalRifas').textContent = '12';
                document.getElementById('totalUsuarios').textContent = '248';
                document.getElementById('totalInstituciones').textContent = '8';
                document.getElementById('totalVentas').textContent = '$45,280';

                // TODO: Implementar llamadas reales a las APIs cuando est√©n listas
                /*
                const [rifasRes, usuariosRes, institucionesRes] = await Promise.all([
                    authService.authenticatedRequest('/api/rifas/stats'),
                    authService.authenticatedRequest('/api/usuarios/stats'),
                    authService.authenticatedRequest('/api/instituciones/stats')
                ]);
                */

            } catch (error) {
                console.error('Error cargando estad√≠sticas:', error);
            }
        }

        // Cargar actividad reciente
        async function loadRecentActivity() {
            const container = document.getElementById('activityContainer');
            
            try {
                // Por ahora mostramos actividad mock
                const mockActivity = [
                    {
                        icon: 'üé´',
                        title: 'Nueva rifa creada: "Sorteo Solidario Marzo"',
                        time: 'Hace 2 horas'
                    },
                    {
                        icon: 'üë§',
                        title: 'Nuevo usuario registrado: Mar√≠a Gonz√°lez',
                        time: 'Hace 4 horas'
                    },
                    {
                        icon: 'üí∞',
                        title: 'Venta realizada: 5 n√∫meros vendidos',
                        time: 'Hace 6 horas'
                    },
                    {
                        icon: 'üèÜ',
                        title: 'Sorteo finalizado: "Rifa Febrero"',
                        time: 'Hace 1 d√≠a'
                    }
                ];

                container.innerHTML = mockActivity.map(activity => `
                    <div class="activity-item">
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-content">
                            <div class="activity-title">${activity.title}</div>
                            <div class="activity-time">${activity.time}</div>
                        </div>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error cargando actividad:', error);
                container.innerHTML = '<p style="text-align: center; color: #666;">Error cargando actividad reciente</p>';
            }
        }

        // Manejar logout
        async function handleLogout() {
            if (confirm('¬øEst√°s seguro que deseas cerrar sesi√≥n?')) {
                try {
                    await authService.logout();
                    authService.redirectToLogin();
                } catch (error) {
                    console.error('Error en logout:', error);
                    // Forzar logout local si falla la request
                    authService.clearAuthData();
                    authService.redirectToLogin();
                }
            }
        }

        // Funci√≥n para mostrar alertas
        function showAlert(message, type = 'error') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const container = document.querySelector('.container');
            container.insertBefore(alertDiv, container.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

        // Actualizar datos cada 5 minutos
        setInterval(loadDashboardData, 5 * 60 * 1000);
    </script>
    <script src="js/config.js"></script>
    <script src="js/authService.js"></script>
</body>
</html>