<!-- src/app/components/usuarios/usuarios.component.html -->
<div class="usuarios-container">
  <!-- Header -->
  <div class="page-header">
    <h1>üë• Gesti√≥n de Usuarios</h1>
    <button class="btn btn-primary" (click)="abrirModal('create')">
      ‚ûï Nuevo Usuario
    </button>
  </div>

  <!-- Alertas -->
  <div *ngIf="error" class="alert alert-error">
    ‚ùå {{ error }}
  </div>
  
  <div *ngIf="success" class="alert alert-success">
    ‚úÖ {{ success }}
  </div>

  <!-- Filtros -->
  <div class="filters-section">
    <div class="filters-row">
      <div class="filter-group">
        <label>Buscar:</label>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          placeholder="Nombre, apellido o email..."
          class="form-control">
      </div>
      
      <div class="filter-group">
        <label>Rol:</label>
        <select [(ngModel)]="filtroRol" class="form-control">
          <option value="">Todos los roles</option>
          <option *ngFor="let rol of roles" [value]="rol.value">
            {{ rol.label }}
          </option>
        </select>
      </div>
      
      <div class="filter-group">
        <label>Estado:</label>
        <select [(ngModel)]="filtroEstado" class="form-control">
          <option value="">Todos los estados</option>
          <option *ngFor="let estado of estados" [value]="estado.value">
            {{ estado.label }}
          </option>
        </select>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading">
    <p>‚è≥ Cargando usuarios...</p>
  </div>

  <!-- Tabla de usuarios -->
  <div *ngIf="!loading" class="usuarios-table">
    <div class="table-info">
      <p>Total de usuarios: <strong>{{ usuariosFiltrados.length }}</strong></p>
    </div>

    <div class="table-container">
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre Completo</th>
            <th>Email</th>
            <th>Tel√©fono</th>
            <th>Rol</th>
            <th>Instituci√≥n</th>
            <th>Estado</th>
            <th>Fecha Creaci√≥n</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let usuario of usuariosFiltrados" 
              [class.inactive]="usuario.estado === 'inactivo'">
            <td>{{ usuario.id }}</td>
            <td>
              <div class="user-name">
                <strong>{{ usuario.nombre }} {{ usuario.apellido }}</strong>
                <small *ngIf="usuario.dni">DNI: {{ usuario.dni }}</small>
              </div>
            </td>
            <td>{{ usuario.email }}</td>
            <td>{{ usuario.telefono || '-' }}</td>
            <td>
              <span class="badge" [class]="'badge-' + usuario.rol">
                {{ getRolLabel(usuario.rol) }}
              </span>
            </td>
            <td>{{ usuario.institucion_nombre || '-' }}</td>
            <td>
              <span class="status" [class]="'status-' + usuario.estado">
                {{ getEstadoLabel(usuario.estado || 'activo') }}
              </span>
            </td>
            <td>
              <small>{{ usuario.fecha_creacion | date:'dd/MM/yyyy HH:mm' }}</small>
            </td>
            <td>
              <div class="actions">
                <button 
                  class="btn btn-sm btn-secondary" 
                  (click)="abrirModal('view', usuario)"
                  title="Ver detalles">
                  üëÅÔ∏è
                </button>
                <button 
                  class="btn btn-sm btn-primary" 
                  (click)="abrirModal('edit', usuario)"
                  title="Editar">
                  ‚úèÔ∏è
                </button>
                <button 
                  class="btn btn-sm btn-danger" 
                  (click)="eliminarUsuario(usuario)"
                  title="Eliminar">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Estado vac√≠o -->
      <div *ngIf="usuariosFiltrados.length === 0" class="empty-state">
        <p>üì≠ No se encontraron usuarios con los filtros aplicados</p>
        <button class="btn btn-primary" (click)="abrirModal('create')">
          Crear primer usuario
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal -->
<div *ngIf="showModal" class="modal-overlay" (click)="cerrarModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <span *ngIf="modalMode === 'create'">‚ûï Crear Usuario</span>
        <span *ngIf="modalMode === 'edit'">‚úèÔ∏è Editar Usuario</span>
        <span *ngIf="modalMode === 'view'">üëÅÔ∏è Detalles del Usuario</span>
      </h2>
      <button class="btn-close" (click)="cerrarModal()">‚úñÔ∏è</button>
    </div>

    <div class="modal-body">
      <!-- Alertas del modal -->
      <div *ngIf="error" class="alert alert-error">
        ‚ùå {{ error }}
      </div>
      
      <div *ngIf="success" class="alert alert-success">
        ‚úÖ {{ success }}
      </div>

      <!-- Vista de detalles -->
      <div *ngIf="modalMode === 'view' && selectedUsuario" class="user-details">
        <div class="detail-row">
          <label>ID:</label>
          <span>{{ selectedUsuario.id }}</span>
        </div>
        <div class="detail-row">
          <label>Nombre completo:</label>
          <span>{{ selectedUsuario.nombre }} {{ selectedUsuario.apellido }}</span>
        </div>
        <div class="detail-row">
          <label>Email:</label>
          <span>{{ selectedUsuario.email }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedUsuario.telefono">
          <label>Tel√©fono:</label>
          <span>{{ selectedUsuario.telefono }}</span>
        </div>
        <div class="detail-row" *ngIf="selectedUsuario.dni">
          <label>DNI:</label>
          <span>{{ selectedUsuario.dni }}</span>
        </div>
        <div class="detail-row">
          <label>Rol:</label>
          <span class="badge" [class]="'badge-' + selectedUsuario.rol">
            {{ getRolLabel(selectedUsuario.rol) }}
          </span>
        </div>
        <div class="detail-row" *ngIf="selectedUsuario.institucion_nombre">
          <label>Instituci√≥n:</label>
          <span>{{ selectedUsuario.institucion_nombre }}</span>
        </div>
        <div class="detail-row">
          <label>Estado:</label>
          <span class="status" [class]="'status-' + selectedUsuario.estado">
            {{ getEstadoLabel(selectedUsuario.estado || 'activo') }}
          </span>
        </div>
        <div class="detail-row">
          <label>Fecha de creaci√≥n:</label>
          <span>{{ selectedUsuario.fecha_creacion | date:'dd/MM/yyyy HH:mm:ss' }}</span>
        </div>
      </div>

      <!-- Formulario -->
      <form *ngIf="modalMode !== 'view'" [formGroup]="usuarioForm" (ngSubmit)="onSubmit()">
        <div class="form-row">
          <div class="form-group">
            <label for="nombre">Nombre *</label>
            <input 
              type="text" 
              id="nombre"
              formControlName="nombre" 
              class="form-control"
              [class.error]="usuarioForm.get('nombre')?.touched && usuarioForm.get('nombre')?.invalid">
            <small *ngIf="usuarioForm.get('nombre')?.touched && usuarioForm.get('nombre')?.errors?.['required']" 
                   class="error-message">
              El nombre es requerido
            </small>
            <small *ngIf="usuarioForm.get('nombre')?.touched && usuarioForm.get('nombre')?.errors?.['minlength']" 
                   class="error-message">
              El nombre debe tener al menos 2 caracteres
            </small>
          </div>

          <div class="form-group">
            <label for="apellido">Apellido *</label>
            <input 
              type="text" 
              id="apellido"
              formControlName="apellido" 
              class="form-control"
              [class.error]="usuarioForm.get('apellido')?.touched && usuarioForm.get('apellido')?.invalid">
            <small *ngIf="usuarioForm.get('apellido')?.touched && usuarioForm.get('apellido')?.errors?.['required']" 
                   class="error-message">
              El apellido es requerido
            </small>
          </div>
        </div>

        <div class="form-group">
          <label for="email">Email *</label>
          <input 
            type="email" 
            id="email"
            formControlName="email" 
            class="form-control"
            [class.error]="usuarioForm.get('email')?.touched && usuarioForm.get('email')?.invalid">
          <small *ngIf="usuarioForm.get('email')?.touched && usuarioForm.get('email')?.errors?.['required']" 
                 class="error-message">
            El email es requerido
          </small>
          <small *ngIf="usuarioForm.get('email')?.touched && usuarioForm.get('email')?.errors?.['email']" 
                 class="error-message">
            El formato del email no es v√°lido
          </small>
        </div>

        <div class="form-group" *ngIf="modalMode === 'create' || (modalMode === 'edit' && usuarioForm.get('password')?.value)">
          <label for="password">
            {{ modalMode === 'create' ? 'Contrase√±a *' : 'Nueva Contrase√±a (opcional)' }}
          </label>
          <input 
            type="password" 
            id="password"
            formControlName="password" 
            class="form-control"
            [class.error]="usuarioForm.get('password')?.touched && usuarioForm.get('password')?.invalid">
          <small *ngIf="usuarioForm.get('password')?.touched && usuarioForm.get('password')?.errors?.['required']" 
                 class="error-message">
            La contrase√±a es requerida
          </small>
          <small *ngIf="usuarioForm.get('password')?.touched && usuarioForm.get('password')?.errors?.['minlength']" 
                 class="error-message">
            La contrase√±a debe tener al menos 6 caracteres
          </small>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="telefono">Tel√©fono</label>
            <input 
              type="tel" 
              id="telefono"
              formControlName="telefono" 
              class="form-control"
              placeholder="+54 11 1234-5678">
          </div>

          <div class="form-group">
            <label for="dni">DNI</label>
            <input 
              type="text" 
              id="dni"
              formControlName="dni" 
              class="form-control"
              placeholder="12345678">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="rol">Rol *</label>
            <select 
              id="rol"
              formControlName="rol" 
              class="form-control"
              [class.error]="usuarioForm.get('rol')?.touched && usuarioForm.get('rol')?.invalid">
              <option *ngFor="let rol of roles" [value]="rol.value">
                {{ rol.label }}
              </option>
            </select>
          </div>

          <div class="form-group">
            <label for="institucion_id">Instituci√≥n</label>
            <select 
              id="institucion_id"
              formControlName="institucion_id" 
              class="form-control">
              <option value="">Sin instituci√≥n</option>
              <option *ngFor="let institucion of instituciones" [value]="institucion.id">
                {{ institucion.nombre }}
              </option>
            </select>
          </div>
        </div>

        <div class="form-group" *ngIf="modalMode === 'edit'">
          <label for="estado">Estado</label>
          <select 
            id="estado"
            formControlName="estado" 
            class="form-control">
            <option *ngFor="let estado of estados" [value]="estado.value">
              {{ estado.label }}
            </option>
          </select>
        </div>
      </form>
    </div>

    <div class="modal-footer" *ngIf="modalMode !== 'view'">
      <button type="button" class="btn btn-secondary" (click)="cerrarModal()">
        Cancelar
      </button>
      <button 
        type="submit" 
        class="btn btn-primary" 
        (click)="onSubmit()"
        [disabled]="loading || usuarioForm.invalid">
        <span *ngIf="loading">‚è≥</span>
        {{ modalMode === 'create' ? 'Crear Usuario' : 'Actualizar Usuario' }}
      </button>
    </div>
  </div>
</div>